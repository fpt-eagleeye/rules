rule win_sality_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2020-05-30"
        version = "1"
        description = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.4.0"
        tool_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.sality"
        malpedia_rule_date = "20200529"
        malpedia_hash = "92c362319514e5a6da26204961446caa3a8b32a8"
        malpedia_version = "20200529"
        malpedia_license = "CC BY-NC-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using yara-signator.
     * The code and documentation / approach is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 8b45ec 25ff000000 8b4df8 034df4 8b55f8 8a0402 }
            // n = 6, score = 600
            //   8b45ec               | mov                 eax, dword ptr [ebp - 0x14]
            //   25ff000000           | and                 eax, 0xff
            //   8b4df8               | mov                 ecx, dword ptr [ebp - 8]
            //   034df4               | add                 ecx, dword ptr [ebp - 0xc]
            //   8b55f8               | mov                 edx, dword ptr [ebp - 8]
            //   8a0402               | mov                 al, byte ptr [edx + eax]

        $sequence_1 = { 888800010000 c745f000000000 8b55f0 8955f4 }
            // n = 4, score = 600
            //   888800010000         | mov                 byte ptr [eax + 0x100], cl
            //   c745f000000000       | mov                 dword ptr [ebp - 0x10], 0
            //   8b55f0               | mov                 edx, dword ptr [ebp - 0x10]
            //   8955f4               | mov                 dword ptr [ebp - 0xc], edx

        $sequence_2 = { 83c101 894df4 817df400010000 7d0d }
            // n = 4, score = 600
            //   83c101               | add                 ecx, 1
            //   894df4               | mov                 dword ptr [ebp - 0xc], ecx
            //   817df400010000       | cmp                 dword ptr [ebp - 0xc], 0x100
            //   7d0d                 | jge                 0xf

        $sequence_3 = { 8b45f8 8a0c10 884dfc 8a55ec 0255fc 8855ec 8b45ec }
            // n = 7, score = 600
            //   8b45f8               | mov                 eax, dword ptr [ebp - 8]
            //   8a0c10               | mov                 cl, byte ptr [eax + edx]
            //   884dfc               | mov                 byte ptr [ebp - 4], cl
            //   8a55ec               | mov                 dl, byte ptr [ebp - 0x14]
            //   0255fc               | add                 dl, byte ptr [ebp - 4]
            //   8855ec               | mov                 byte ptr [ebp - 0x14], dl
            //   8b45ec               | mov                 eax, dword ptr [ebp - 0x14]

        $sequence_4 = { 8b4d10 8a55f4 889100010000 8b4510 8a4dec 888801010000 }
            // n = 6, score = 600
            //   8b4d10               | mov                 ecx, dword ptr [ebp + 0x10]
            //   8a55f4               | mov                 dl, byte ptr [ebp - 0xc]
            //   889100010000         | mov                 byte ptr [ecx + 0x100], dl
            //   8b4510               | mov                 eax, dword ptr [ebp + 0x10]
            //   8a4dec               | mov                 cl, byte ptr [ebp - 0x14]
            //   888801010000         | mov                 byte ptr [eax + 0x101], cl

        $sequence_5 = { 3b450c 0f8d8c000000 8a4df4 80c101 884df4 }
            // n = 5, score = 600
            //   3b450c               | cmp                 eax, dword ptr [ebp + 0xc]
            //   0f8d8c000000         | jge                 0x92
            //   8a4df4               | mov                 cl, byte ptr [ebp - 0xc]
            //   80c101               | add                 cl, 1
            //   884df4               | mov                 byte ptr [ebp - 0xc], cl

        $sequence_6 = { 8b45f4 83c001 8945f4 8b45f0 99 f77d0c 8955f0 }
            // n = 7, score = 600
            //   8b45f4               | mov                 eax, dword ptr [ebp - 0xc]
            //   83c001               | add                 eax, 1
            //   8945f4               | mov                 dword ptr [ebp - 0xc], eax
            //   8b45f0               | mov                 eax, dword ptr [ebp - 0x10]
            //   99                   | cdq                 
            //   f77d0c               | idiv                dword ptr [ebp + 0xc]
            //   8955f0               | mov                 dword ptr [ebp - 0x10], edx

        $sequence_7 = { 8a11 8855fc 8b45fc 25ff000000 8b4d08 034df0 }
            // n = 6, score = 600
            //   8a11                 | mov                 dl, byte ptr [ecx]
            //   8855fc               | mov                 byte ptr [ebp - 4], dl
            //   8b45fc               | mov                 eax, dword ptr [ebp - 4]
            //   25ff000000           | and                 eax, 0xff
            //   8b4d08               | mov                 ecx, dword ptr [ebp + 8]
            //   034df0               | add                 ecx, dword ptr [ebp - 0x10]

        $sequence_8 = { 8d45fb 50 e8???????? 58 ff30 e8???????? }
            // n = 6, score = 100
            //   8d45fb               | lea                 eax, [ebp - 5]
            //   50                   | push                eax
            //   e8????????           |                     
            //   58                   | pop                 eax
            //   ff30                 | push                dword ptr [eax]
            //   e8????????           |                     

        $sequence_9 = { f3a6 7505 83c404 eb0a 59 83c304 }
            // n = 6, score = 100
            //   f3a6                 | repe cmpsb          byte ptr [esi], byte ptr es:[edi]
            //   7505                 | jne                 7
            //   83c404               | add                 esp, 4
            //   eb0a                 | jmp                 0xc
            //   59                   | pop                 ecx
            //   83c304               | add                 ebx, 4

        $sequence_10 = { 68???????? e8???????? 833800 0f8592010000 833d????????1e 7c05 }
            // n = 6, score = 100
            //   68????????           |                     
            //   e8????????           |                     
            //   833800               | cmp                 dword ptr [eax], 0
            //   0f8592010000         | jne                 0x198
            //   833d????????1e       |                     
            //   7c05                 | jl                  7

        $sequence_11 = { 8d9dba114000 895808 646789260000 8b74240c 66813e4d5a 0f858c000000 03763c }
            // n = 7, score = 100
            //   8d9dba114000         | lea                 ebx, [ebp + 0x4011ba]
            //   895808               | mov                 dword ptr [eax + 8], ebx
            //   646789260000         | mov                 dword ptr fs:[0], esp
            //   8b74240c             | mov                 esi, dword ptr [esp + 0xc]
            //   66813e4d5a           | cmp                 word ptr [esi], 0x5a4d
            //   0f858c000000         | jne                 0x92
            //   03763c               | add                 esi, dword ptr [esi + 0x3c]

        $sequence_12 = { 7514 51 56 57 8bca }
            // n = 5, score = 100
            //   7514                 | jne                 0x16
            //   51                   | push                ecx
            //   56                   | push                esi
            //   57                   | push                edi
            //   8bca                 | mov                 ecx, edx

        $sequence_13 = { 6a00 e8???????? 8bf8 56 6a00 }
            // n = 5, score = 100
            //   6a00                 | push                0
            //   e8????????           |                     
            //   8bf8                 | mov                 edi, eax
            //   56                   | push                esi
            //   6a00                 | push                0

        $sequence_14 = { 8981f0000000 8b0d???????? b8???????? 8981f4000000 8b0d???????? b8???????? }
            // n = 6, score = 100
            //   8981f0000000         | mov                 dword ptr [ecx + 0xf0], eax
            //   8b0d????????         |                     
            //   b8????????           |                     
            //   8981f4000000         | mov                 dword ptr [ecx + 0xf4], eax
            //   8b0d????????         |                     
            //   b8????????           |                     

        $sequence_15 = { 0f84b9000000 6a00 6a00 6a00 6a06 }
            // n = 5, score = 100
            //   0f84b9000000         | je                  0xbf
            //   6a00                 | push                0
            //   6a00                 | push                0
            //   6a00                 | push                0
            //   6a06                 | push                6

        $sequence_16 = { 56 8b85dcf4ffff 50 e8???????? 83f8ff }
            // n = 5, score = 100
            //   56                   | push                esi
            //   8b85dcf4ffff         | mov                 eax, dword ptr [ebp - 0xb24]
            //   50                   | push                eax
            //   e8????????           |                     
            //   83f8ff               | cmp                 eax, -1

        $sequence_17 = { ffb5cf1e4000 ff955d144000 6a00 6a00 ffb58b234000 ffb5c2164000 }
            // n = 6, score = 100
            //   ffb5cf1e4000         | push                dword ptr [ebp + 0x401ecf]
            //   ff955d144000         | call                dword ptr [ebp + 0x40145d]
            //   6a00                 | push                0
            //   6a00                 | push                0
            //   ffb58b234000         | push                dword ptr [ebp + 0x40238b]
            //   ffb5c2164000         | push                dword ptr [ebp + 0x4016c2]

        $sequence_18 = { 8d95d71e4000 52 ff95ef154000 8d9545164000 52 }
            // n = 5, score = 100
            //   8d95d71e4000         | lea                 edx, [ebp + 0x401ed7]
            //   52                   | push                edx
            //   ff95ef154000         | call                dword ptr [ebp + 0x4015ef]
            //   8d9545164000         | lea                 edx, [ebp + 0x401645]
            //   52                   | push                edx

        $sequence_19 = { 52 ff95c9154000 8d95d81f4000 52 8d95d71e4000 52 ff95c9154000 }
            // n = 7, score = 100
            //   52                   | push                edx
            //   ff95c9154000         | call                dword ptr [ebp + 0x4015c9]
            //   8d95d81f4000         | lea                 edx, [ebp + 0x401fd8]
            //   52                   | push                edx
            //   8d95d71e4000         | lea                 edx, [ebp + 0x401ed7]
            //   52                   | push                edx
            //   ff95c9154000         | call                dword ptr [ebp + 0x4015c9]

        $sequence_20 = { 8985d31e4000 85c0 0f8490000000 b80c000000 83bc058b23400000 7424 }
            // n = 6, score = 100
            //   8985d31e4000         | mov                 dword ptr [ebp + 0x401ed3], eax
            //   85c0                 | test                eax, eax
            //   0f8490000000         | je                  0x96
            //   b80c000000           | mov                 eax, 0xc
            //   83bc058b23400000     | cmp                 dword ptr [ebp + eax + 0x40238b], 0
            //   7424                 | je                  0x26

        $sequence_21 = { ffb5ba164000 6a00 6a04 6a00 }
            // n = 4, score = 100
            //   ffb5ba164000         | push                dword ptr [ebp + 0x4016ba]
            //   6a00                 | push                0
            //   6a04                 | push                4
            //   6a00                 | push                0

        $sequence_22 = { 0fb7ca 8b4508 89048d7d504100 8b4508 c70485????????00100000 8b4508 }
            // n = 6, score = 100
            //   0fb7ca               | movzx               ecx, dx
            //   8b4508               | mov                 eax, dword ptr [ebp + 8]
            //   89048d7d504100       | mov                 dword ptr [ecx*4 + 0x41507d], eax
            //   8b4508               | mov                 eax, dword ptr [ebp + 8]
            //   c70485????????00100000     |     
            //   8b4508               | mov                 eax, dword ptr [ebp + 8]

        $sequence_23 = { 50 8d8558faffff 50 8d855cfaffff 50 }
            // n = 5, score = 100
            //   50                   | push                eax
            //   8d8558faffff         | lea                 eax, [ebp - 0x5a8]
            //   50                   | push                eax
            //   8d855cfaffff         | lea                 eax, [ebp - 0x5a4]
            //   50                   | push                eax

    condition:
        7 of them and filesize < 5791744
}